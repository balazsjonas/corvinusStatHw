---
title: "Többváltozós adatelemzési modellek"
author: |-
  Jónás Balázs
  K377FK
date: "1/11/2022"
output:
  word_document: default
---

```{r warning=FALSE, include=FALSE}
# install.packages("rmarkdown") # dokumentáció
# install.packages("readxl") # Excel
# install.packages("RcmdrMisc")
# install.packages("tidyr")
# install.packages("psych") # csúcsosság, ferdeség
# install.packages("rcompanion")
# install.packages("ggplot2")
# install.packages("questionr") # Cramer
library(readxl, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(RcmdrMisc, warn.conflicts = FALSE)
library(psych, warn.conflicts = FALSE)
library(rcompanion, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)
library(questionr, warn.conflicts = FALSE)
```

# Probléma felvetése

Célom a magyar államkötvények első forgalomba hozatalának vizsgálata. 

Az első részben bemutatom az adat forrását és ismérveit. A második részben az 5 éves lejárat aukcióinak forgalmi adatait és az különböző lejáratok gyakoriságát vizsgáltam. A harmadik részben másik változót, a kötvény kibocsátáskori hozamát vizsgáltam, valamint ennek változását az elmúlt évtizedekben.
Az 5 éves lejárat aukcióinak forgalmi és hozam adatait vizsgáltam. 

Meg kell jegyezni, hogy az ismérvek időfüggését figyelmen kívül hagytam és idő helyett nagyobb időszakokat, mint kategóriákat használtam. Mivel a táblázat az összes aukció adatát tartalmazza, ezért az intervallumbecslések feltételei automatikusan teljesülnek.


# TODO Leíró statisztikához az elfogadott mennyiség

## Adatok forrása és feldolgozása
Forrás: https://akk.hu/statistics/historical-data

Elérés: 2022. január 10 du. 5:39

A táblázat a magyar államkötvények aukciók tartalmazza 1987-től, 21 ismérvet és 3758 megfigyelést tartalmaz.
```{r warning=FALSE, include=FALSE}
## Adatok betöltése és tisztítása ====
auctions <- read_excel("AUCTION_220110173944.xlsx")
auctions <- as.data.frame(auctions)
year <- as.numeric(format(auctions$Date, format="%Y"))
periodLength <- 10
periodStarts <- seq(1990, 2030, periodLength)
period <- .bincode(year, periodStarts, right=F)
auctions$Period  <- as.factor(paste(
  periodStarts[period],
  "-", 
  periodStarts[period]+periodLength-1))
# 1 éves lejáratra kétféle jelölést használtak
auctions$Tenor[auctions$Tenor=="12M"]<-"1Y"

referenceBonds <- c("3M", "6M",
                    "1Y", "3Y","5Y",
                    "10Y", "15Y", "20Y",
                    "other")
auctions$Tenor<- factor(auctions$Tenor,
                        levels=referenceBonds)
auctions$Tenor <- auctions$Tenor %>% replace_na(replace = "other")

# Szűrés új kibocsátásokra és fix kamatozási kötvényekre
issues<-auctions[auctions$Type=="ISSUE"
                 & auctions$`Interest Type`!="Float",]
```



## Adatok jellemzése


|Oszlop neve|Tipusa|Jelentése|
| :---: | :----: |  :---: |
|Type|Nominális|Tranzakció típusa: *ISSUE* (elsődleges kibocsátás), *BUYBACK*(visszavásárlási aukció), *SUBSCRIPTION* (jegyzés), *NON_COMPETETITIVE* (aukciót követő jegyzési mód), *TAP_ISSUE* (rábocsátás), *SWITCH* (csereaukció) |
|Tenor|Ordinális|A kötvény futamidejét jelöli években, hónapokban vagy hetekben. Fontos megjegyezni, hogy ebben az esetben a különbség nem értelmezhető, ezért nem tekinthető intervallum típusnak|
|Security Type|Nominális|A kötvény típusát jelöli|
|Alias|Nominális|A kötvény rövid neve.|
|Date|Intervallum|Az aukció dátuma. A dolgozatban nem vettem figyelembe az ismérvek időbeli alakulását, csak néhány helyen a jelenség megértésénél használtam fel.|
|Settlement|Intervallum|Az elszámolás napja.|
|Maturity Date|Intervallum|A kötvény lejáratának napja.|
|Interest Type|Nominális|Diszkont, fix vagy változó kamatozású kötvény|

### A Kötvények keresletére, hozamára és árára vonatkozó adatok

|Oszlop neve|Tipusa|Jelentése|
| :---: | :----: |  :---: |
|Announced (mln)|Arányskála|Meghirdetett mennyiség névértéke millió forintban|
|Bid Amount (mln)|Arányskála|Benyújtott mennyiség névértéke millió forintban|
|Accepted (mln)|Arányskála|Elfogadott mennyiség névértéke millió forintban|
|Min Yield (%)|Arányskála|Az elfogadott ajánlatok közül a legalacsonyabb hozamú ajánlat|
|Max Yield (%)|Arányskála|Az elfogadott ajánlatok közül a legmagasabb hozamú ajánlat|
|Avg Yield (%)|Arányskála|Az elfogadott ajánlatok mennyiséggel súlyozott átlaga|
|Min Price (%)|Arányskála|Az elfogadott ajánlatok közül a legalacsonyabb árfolyamú a névérték százalékában|
|Max Price (%)|Arányskála|Az elfogadott ajánlatok közül a legmagasabb árfolyamú a névérték százalékában|
|Avg Price (%)|Arányskála|Az elfogadott ajánlatok közül árfolyamainak mennyiséggel súlyozott átlaga a névérték százalékában|

### számított oszlopok
Hasznosnak tartottam kiemelni a dátumból az évet. Ezt a dataframeben "Year"-nek neveztem, intervallum típusú ismérv.


Az idő helyett 10 éves időszakokat vizsgáltam. Jelenleg diszjunkt időszakok, amelyeken a rendezés értelmezett, ezért tekinthető ordinális típusnak.


### Megjegyzések

A dolgozatban csak az elsődleges kibocsátások (ISSUE) ismérveit fogom vizsgálni.

A Tenor változóban kötvény tipusától függően különböző jelölést használtak az 1 éves referencia papír esetén: diszkont kincstárjegy esetén "12M", államkötvény esetén az "1Y" jelölést használták. Az adattisztítás során egységes "1Y"-ra cseréltem.
<!-- Példa: -->
<!-- Type	Tenor	Security Type	Alias	Date	Settlement	Interest Type	Announced (mln)	Maturity Date -->
<!-- ISSUE	10Y	KTV	2013/D	2003.05.15	2003.05.22	Fix	30,000.00	2013.02.12 -->
<!-- ISSUE	3Y	KTV	2013/D	2009.05.07	2009.05.13	Fix	5,000.00	2013.02.12 -->


Hozamok és árfolyamok csak akkor értelmezhetőek, ha az elfogadott mennyiség pozitív, azaz sikeres volt az aukció. A sikertelen aukciókat a hozamok vizsgálatakor kiszűrtem.

<!-- Fel nem használt ismérvek -->
A "Pro-rata (%)", "Bid pcs", "Accepted pcs" ismérvek pontos definícióját nem találtam meg. Bár az "ISIN" számít az értékpapír azonosítójának, nem lesz szükség rá. A további oszlopok a csereaukciók során felajánlott értékpapírok.



# Megszorítások
Csak az elsődleges kibocsátásokat veszem figyelembe
Nem veszem figyelembe a lakossági állampapírokat, mivel ezek értékesítése nem piaci alapot történik, nem tükrözi a magyar állammal szembeni ??
Devizát sem, 
  Devizaárfolyam, valamit az adott devizához tartozó referencia papírnak tekintett állampapírok (pl dollár esetén USA, euró esetén a német állam által kibocsátott kötvények) ismerete nélkül kevés információt szolgáltat.
Csereaukciók: nem jut új forráshoz az állam, mind a vevő, mind az eladó részéről elsősorban kockázatkezelési célokat szolgál.

visszavásárlások: Ebben az esetben az állam vevő szerepében jelenik meg, gyakran a lejáratok előtt több részletben vásárolnak vissza kötvényeket

Abban az esetben, ha egy aukció eredménytelen volt, a hozam értéke nem értelmezhető.

<!-- A táblázat tartalmaz egy hibát, amit javítottam-->


# 2. Elsődleges piacon kibocsátott 5 éves államkötvények leíró statisztikája

Az olvashatóság javítása érdekében az elfogadott mennyiségeket a táblázathoz képest milliárd forintban jelenítem meg.

## Gyakoriság
```{r include=FALSE}
bond5 <- issues[issues$Tenor == "5Y", c("Date", "Accepted (mln)", "Avg Yield (%)", "Period")]
# Oszlopok nevét egyszerűsítem
colnames(bond5) <- c("Date", "AcceptedAmount", "Yield", "Period")
# Olvashatóság miatt az elfogadott mennyiséget millárd forintban használom
bond5$AcceptedAmount <- bond5$AcceptedAmount/1000
```
```{r echo=TRUE, message=TRUE}
binnedCounts(bond5$AcceptedAmount, breaks = 6)
```
## Hisztogram
```{r echo=FALSE, message=TRUE}
ggplot(data=bond5, aes(x=AcceptedAmount)) +
  geom_histogram(bins=16)+
  labs(title="Az elfogadott mennyiségek\naz 5 éves kötvények elsődleges kibocsátásakor",
       x="Elfogadott mennyiség (milliárd Forint)",
       y= "Gyakoriság (db)")
```

## Helyzetmutatók és kvantilisek
```{r message=FALSE, include=FALSE}
acceptedBonds5 <- bond5$AcceptedAmount
mostFrequentValues <- names(table(acceptedBonds5)[table(acceptedBonds5) == max(table(acceptedBonds5))])
modusz <- mean(as.numeric(mostFrequentValues))
```
```{r echo=FALSE, message=FALSE}
sprintf("módusz: %s", modusz)
sprintf("medián: %s", median(acceptedBonds5, na.rm = TRUE))
sprintf("átlag: %s", format(mean(acceptedBonds5, na.rm = TRUE), digits =3))
sprintf("szórás: %s", format(sd(acceptedBonds5, na.rm = T), digits = 3))
sprintf("relatív szórás: %s", sd(acceptedBonds5, na.rm = T)/mean(acceptedBonds5, na.rm = T))
describe(acceptedBonds5)
summary(acceptedBonds5)
```

A helyzetmutatók között határozott sorrend állapítható meg: módusz < medián < átlag valamint a ferdeség pozitív. Ez alapján az eloszlás jobbra elnyúló.


## Doboz ábra
```{r echo=FALSE, message=FALSE}
ggplot(data=bond5, aes(y=AcceptedAmount)) +
  geom_boxplot()
```


## Outlierek
```{r message=FALSE, include=FALSE}
q<-summary(acceptedBonds5) # named numbers of min, Q1, median, mean, Q3, max
Q3 <- q[5]
Q1 <- q[2]
korlat = Q3 + 1.5 * (Q3 - Q1)
```

A kiugró értékek dátumai:
```{r echo=FALSE, message=FALSE}
bond5[bond5$AcceptedAmount>korlat, "Date"]
```
A dátumokból látszik, hogy a nagyobb kibocsátások 2007-2008-as és 2020-as nehezebb időkben történek.

# Lejáratok eloszlása
```{r echo=FALSE, message=FALSE}
summary(auctions$Tenor)
```


# 3. Az 5 éves államkötvények hozamának vizsgálata az időszak függvényében

A hozamok vizsgálatakor csak a sikeres aukciókat érdemes figyelembe venni, amit az elfogadott mennyiség alapján lehet kiszűrni. Az 5 éves kötvény esetén ez megegyezik azzal a feltétellel, hogy az átlaghozam pozitív, de bízzunk benne, hogy egyszer nekünk is sikerül 0%-os hozammal forrást bevonni az 5 éves lejáraton. 
<!-- Jelenleg a német 5 éves hozam -0.4%  -->
```{r message=FALSE, include=FALSE}
bond5successful <- bond5[bond5$AcceptedAmount>0, ]
```
```{r echo=FALSE, message=TRUE}
ggplot(data=remove_missing(bond5successful, na.rm=TRUE, vars="Yield"),
  aes(y=Yield, x=Period)) +
  geom_boxplot()
```

## Az átlag hozam becslése időszakok szerint bontva

```{r echo=TRUE, message=TRUE}
groupwiseMean(Yield ~ Period,
              data=bond5successful,
              conf=0.95,
              digits=3,
              na.rm=T)

groupwiseMedian(Yield ~ Period,
              data=bond5successful,
              conf=0.95,
              digits=3,
              R = 1000,
              percentile = TRUE,
              bca = FALSE
              )
```

A három periódusban rendre csökkent a hozam átlaga és mediánja is, a konfidencia-intervallumok között nincs átfedés. Érdekes, hogy mindhárom időszakban a medián kisebb, mint az átlag, a 90-es éveknél a doboz ábrán nem látszik feltűnő ferdeség.

## Lejáratok aránya különböző időszakokban

A kibocsátó érdekelt az átlagos hátralévő futamidő növelésében, mivel ez csökkenti a finanszírozás kockázatait (pl megújítási kockázat, kamatkiadások kockázata). Ez a cél támogatható rövid hátralévő lejáratú kötvények visszavásárlásával vagy cseréjével, vagy éppen a hosszabb lejáratok előnyben részesítése.

Az alábbi ábrán a kibocsátott kötvények mennyisége látható az idő függvényében. 2009 körül startégiaváltás vehető észre: gyakoribb aukciók során kisebb mennyiségek kibocsátása. Ezzel valószínűleg jobban kontrollálható a kockázat és költség.
```{r echo=FALSE}
ggplot(data=bond5, aes(x=Date, y=AcceptedAmount)) +
  geom_point()+
  labs(title = "Kibocsátott 5 éves kötvények az idő függvényében",
      x="Dátum",
      y="Elfogadott mennyiség (Md forint)")
```


Az elmúlt időszak arányai:
```{r echo=FALSE}
round(prop.table(table(issues[issues$Period=="2010 - 2019", "Tenor"]))*100, 1)
```

```{r include=FALSE}
auctionTypes <- issues[, c("Period", "Tenor") ]
auctionTypes$fiveYear <- 0
auctionTypes$fiveYear[auctionTypes$Tenor == "5Y"] <- 1
```

Az ötéves aukciók aránya az egész mintában és időszakok szerint bontva:
```{r echo=FALSE}
groupwiseMean(fiveYear ~ 1,
              data=auctionTypes,
              conf=0.95,
              digits=3)
groupwiseMean(fiveYear ~ Period,
              data=auctionTypes, 
              conf = 0.95,
              digits = 3,
              na.rm = TRUE
              )
```
A 2000-es és 2010-es évek között egyértelmű a különbség, a konfidencia-intervallumok távol vannak egymástól. A 2020-szal kezdődő időszakra nem egyértelmű az arány növekedése.

## Egymintás hipotézisvizsgálat
### 1. hipotézis vizsgálat
Igaz-e, hogy az Államadósság Kezelő több ajánlatot fogad el, mint amennyit meghirdet. Ez átfogalmazva azt jelenti, hogy az elfogadott és meghirdetett mennyiség hányadosa nagyobb mint 1.

```{r include=FALSE}
bond3 <- issues[issues$Tenor=="3M",]
bond3$Rate <- bond3$`Accepted (mln)`/bond3$`Announced (mln)`
```
Állítás: elfogadott / meghirdetett > 1

H0: mu = 1

H1: mu <1

```{r echo=TRUE}
t.test(bond3$Rate, mu = 1, alternative = "less")
```

A p-érték 1, vagyis bármely szignifikancia szint mellett elfogadjuk H0-t, az állítás stabil.

A legfrissebb aukció eredménye itt érhető el:

https://akk.hu/statistics/auction-results/discount-treasury-bill-auctions


### 2. hipotiézis vizsgálat

Igaz-e, hogy az 5 éves hozamok mediánja 4.9%? Ahogy korábban láttuk a 2000-es évek és 2010-es évek átlaghozama jelentősen eltér. Az egész időszakra nézve az eloszlás bimodális.

H0: median == 4.9

H1: median != 4.9

```{r echo=TRUE}
wilcox.test(bond5$Yield, mu=4.9, exact=FALSE)
```

A p-érték 0.54, elfogadjuk H0-t.

# Kétváltozós kapcsoslatvizsgálat
## Időszak és lejárat kapcsolata

```{r echo=TRUE}
ggplot(data=subset(issues,issues$`Accepted (mln)`> 0 ), 
       aes(x=Period, fill =Tenor)) +
  geom_bar(position="fill") +
  scale_fill_brewer(palette="Dark2")
```

Az 5 és 10 éves lejáratok aránya emelkedett a három időszak folyamán.

``` {r echo=TRUE}
cramer.v(table(issues[issues$`Accepted (mln)`>0,c("Period", "Tenor")]))
```

A Cramer-együttható értéke 0.2882, a kapcsolat gyenge.

További kérdés, hogy a "sokaságban", vagyis a későbbi aukciók során is megmarad ez a gyenge kapcsolat, 

``` {r echo=TRUE}
chisq.test(table(issues[issues$`Accepted (mln)`>0,c("Period", "Tenor")]))
```
A p-érték lényegében 0-nak tekinthető, ezért semmilyen alfa érték mellett nem tudjuk elvetni H1-et, vagyis a kapcsolat gyenge, de szignifikáns.

## Időszak és hozam kapcsolata

```{r echo=TRUE}
aov(Yield ~ Period, data=bond5[bond5$AcceptedAmount>0,])
sprintf("Between: %s", 2143.8)
sprintf("Residuals: %s", 1672.6)
sprintf("H2: %s", 2143.8/ (2143.8 + 1672.6))
```

A variancia-hányados 56.2%, a p-érték lényegében 0, kisebb 1% alfánál is, így H0 elutasítható, így a időszak és hozam kapcsolata erős és szignifikáns.

Feltételek ellenőrzése:
```{r echo=TRUE}
ks.test(bond5[bond5$AcceptedAmount>0 & bond5$Period=="2000 - 2009",]$Yield, "pnorm")
```
```{r echo=FALSE}
sprintf("2000-2009-es időszak hozamainak szórása: %s",
        sd(bond5[bond5$AcceptedAmount>0 & bond5$Period=="2000 - 2009",]$Yield))
sprintf("2010-2019-es időszak hozamainak szórása: %s",
        sd(bond5[bond5$AcceptedAmount>0 & bond5$Period=="2010 - 2019",]$Yield))

```
A Kolmogorov-Smirnov test szerint a p-érték lényegében 0, ezért a null-hipotézist el kell vetnünk, vagyis az első időszakban a hozamok nem normális eloszlásúak. Az azonos szórás feltétele is sérül. Ezek miatt a korábban számított p-érték nem megbízható.



# TODO
hiba javítása
csak fix
https://akk.hu/statisztika/hozamok-indexek-forgalmi-adatok/referenciahozamok
# konfidencia intervallum: sokaság: jövőbeli aukciók
# Idő szándékos figyelmen kívül hagyása
# feliratok, x, y tengelyek


