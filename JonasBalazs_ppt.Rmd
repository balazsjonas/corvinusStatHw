---
title: "Államkötvények leíró statisztikája"
author: "Jónás Balázs"
date: "1/19/2022"
output: ioslides_presentation
---

```{r warning=FALSE, include=FALSE}
# install.packages("rmarkdown") # dokumentáció
# install.packages("readxl") # Excel
# install.packages("RcmdrMisc")
# install.packages("tidyr")
# install.packages("psych") # csúcsosság, ferdeség
# install.packages("rcompanion")
# install.packages("ggplot2")
# install.packages("questionr") # Cramer
# install.packages("lawstat") # levene.test
library(readxl, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(RcmdrMisc, warn.conflicts = FALSE)
library(psych, warn.conflicts = FALSE)
library(rcompanion, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)
library(questionr, warn.conflicts = FALSE)
library(lawstat, warn.conflicts = FALSE)
```

## Tartalom

<!-- motiváció -->
1. Adatok bemutatása
2. Leíró statisztika: 5 éves kötvény aukciók
3. Intervallumbecslés, egymintás hipotézisvizsgálat
4. Kapcsolatvizsgálatok

## Adatok bemutatása

|Oszlop neve|Tipusa|
| :----: | :----: |
|Type|Nominális|
|Tenor|Ordinális|
|Date|Intervallum|
|...|...|...|
|Announced (mln)|Arányskála|
|...|...|...|
|Avg Yield (%)|Arányskála|


```{r include=FALSE}
## Adatok betöltése és tisztítása ====
auctions <- read_excel("AUCTION_220110173944.xlsx")
auctions <- as.data.frame(auctions)
year <- as.numeric(format(auctions$Date, format="%Y"))

# 10 éves időszakok generálása
periodLength <- 10
periodStarts <- seq(1990, 2030, periodLength)
period <- .bincode(year, periodStarts, right=F)
auctions$Period  <- as.factor(paste(
  periodStarts[period],
  "-", 
  periodStarts[period]+periodLength-1))

# 1 éves lejáratra kétféle jelölést használtak
auctions$Tenor[auctions$Tenor=="12M"]<-"1Y"

# https://akk.hu/statisztika/hozamok-indexek-forgalmi-adatok/referenciahozamok
referenceBonds <- c("3M", "6M",
                    "1Y", "3Y","5Y",
                    "10Y", "15Y", "20Y",
                    "other")
# manuális rendezés:
auctions$Tenor<- factor(auctions$Tenor,
                        levels=referenceBonds)
auctions$Tenor <- auctions$Tenor %>% replace_na(replace = "other")

# Szűrés új kibocsátásokra és fix kamatozási kötvényekre
issues<-auctions[auctions$Type=="ISSUE"
                 & auctions$`Interest Type`!="Float",]
```


## Adatok bemutatása: Tenor {data-background=#bbffbb}

Benjamin Button és a kötvény életciklusa.

| Tenor | Alias | Date | Maturity Date | Hátralévő futamidő |
| :---: | :---: | :---: | :---: | :---: |
| 10Y | 2013/D | 2002.01.10 | 2013.02.12 | 11 év 1 hónap | 
| 3Y | 2013/D | 2009.05.07 | 2013.02.12| 3 év 9 hónap |
| 1Y | 2013/D | 2012.04.18 | 2013.02.12 | 10 hónap |
| 6M | 2013/D | 2012.05.16 | 2013.02.12 | 9 hónap |
| 6M | 2013/D | 2012.09.05 | 2013.02.12 | 5 hónap |
| 3M | 2013/D | 2012.09.19 | 2013.02.12 | 5 hónap |
| 3M | 2013/D | 2012.10.31 | 2013.02.12 | 3 hónap |


## Adatok bemutatása: Szűrések

- Lakossági állampapírok
- Devizakötvények
- Csereaukciók
- Visszavásárlások
- Változó kamatozású kötvények


## 5 éves kötvényaukciók

```{r include=FALSE}
bond5 <- issues[issues$Tenor == "5Y", c("Date", "Accepted (mln)", "Avg Yield (%)", "Period", "Avg Price (%)")]

# Oszlopok nevét egyszerűsítem
colnames(bond5) <- c("Date", "AcceptedAmount", "Yield", "Period", "Price")

# Olvashatóság miatt az elfogadott mennyiséget millárd forintban használom
bond5$AcceptedAmount <- bond5$AcceptedAmount/1000
```
```{r echo=FALSE, message=TRUE}
ggplot(data=bond5, aes(x=AcceptedAmount)) +
  geom_histogram(bins=16)+
  labs(title="Az elfogadott mennyiségek az 5 éves kötvények elsődleges kibocsátásakor",
       x="Elfogadott mennyiség (milliárd Forint)",
       y= "Gyakoriság (db)")
```

## 5 éves kötvényaukciók: Helyzetmutatók {data-background=#bbffbb}

```{r message=FALSE, include=FALSE}
acceptedBonds5 <- bond5$AcceptedAmount
mostFrequentValues <- names(table(acceptedBonds5)[table(acceptedBonds5) == max(table(acceptedBonds5))])
modusz <- mean(as.numeric(mostFrequentValues))
```

```{r echo=FALSE, include=TRUE}
summary(acceptedBonds5)
```




## 5 éves kötvényaukciók: Dobozábra {data-background=#bbffbb}


```{r echo=FALSE, include=TRUE,  fig.height=2}
ggplot(data=bond5, aes(y=AcceptedAmount)) +
  geom_boxplot() +
  coord_flip()

```

Az interkvartilis: 18 - 33.5

Jobbra elnyúló esetben az adatok középső 50%-a a minimumhoz van közelebb


## 5 éves aukciók: Korszakonként I.


```{r echo=FALSE, include=TRUE}
ggplot(data=bond5, aes(y=AcceptedAmount, x=Period)) +
  geom_boxplot() +
  labs("Elfogadott ajánlatok az 5 éves aukciókon")
```


## 5 éves aukciók: Korszakonként II.{data-background=#bbffbb}

```{r message=FALSE, include=FALSE}
bond5successful <- bond5[bond5$AcceptedAmount>0, ]
```
```{r echo=FALSE, include=TRUE}
ggplot(data=bond5successful, aes(y=Yield, x=Period)) +
  geom_boxplot() +
  labs("Hozamok az 5 éves aukciókon")
```


## 5 éves aukciók: Korszakonként III.{data-background=#bbffbb}


```{r echo=FALSE, message=TRUE}
groupwiseMean(Yield ~ Period,
              data=bond5successful,
              conf=0.95,
              digits=3,
              na.rm=T)

groupwiseMedian(Yield ~ Period,
              data=bond5successful,
              conf=0.95,
              digits=3,
              R = 1000,
              percentile = TRUE,
              bca = FALSE
              )
```


## 5 éves aukciók: Korszakonként IV.{data-background=#bbffbb}


Hozam időszak függése (ANOVA)

H0: variancia hányados == 0

```{r echo=FALSE, message=TRUE}

summary(aov(Yield ~ Period, data = bond5successful ))
```


SSB = 2144

SSR = 1673

H2 = 0.56 > 50%


## 5 éves aukciók: Korszakonként V.{data-background=#bbffbb}

Feltételezések ellenőrzése.

H0: szórások azonosak a csoportokban

H1: legalább az egyik csoport szórása eltér


```{r echo=TRUE, message=TRUE,  warning=FALSE}
levene.test(bond5successful$Yield, bond5successful$Period)
```

## 5 éves aukciók: Hozamok


```{r echo=FALSE, message=TRUE}
ggplot(data=bond5, aes(x=Yield)) +
  geom_histogram(bins=16)+
  labs(title="Az 5 éves kötvények hozama elsődleges kibocsátásakor",
       x="Hozamok (%)",
       y= "Gyakoriság (db)")
```


## Egymintás hipotézisvizsgálat I.

```{r include=FALSE}
bond3 <- issues[issues$Tenor=="3M",]
bond3$Rate <- bond3$`Accepted (mln)`/bond3$`Announced (mln)`
```

Állítás: elfogadott / meghirdetett >= 1

H0: mu = 1 || H1: mu <1

```{r echo=TRUE}
t1 <- t.test(bond3$Rate, mu = 1, alternative = "less")
sprintf("p-érték: %s", t1$p.value)
```

A p-érték 1, vagyis bármely szignifikancia szint mellett elfogadjuk H0-t, az állítás stabil.

Hamisnak venni H0-t 100%-os hibavalószínűséggel jár

## Egymintás hipotézisvizsgálat II.

Igaz-e, hogy az 5 éves hozamok mediánja 4.9%?

H0: median == 4.9

H1: median != 4.9


```{r echo=TRUE}
wilcox.test(bond5$Yield, mu=4.9, exact=FALSE)
```

A p-érték 0.54, elfogadjuk H0-t. H0 elutatásítása 54% hibával jár.


## Kétváltozós kapcsoslatvizsgálat I.
### Időszak és lejárat kapcsolata


```{r echo=FALSE, warning=FALSE}
ggplot(data=subset(issues,issues$`Accepted (mln)`> 0 ), 
       aes(x=Period, fill =Tenor)) +
  geom_bar(position="fill") +
  scale_fill_brewer(palette="Dark2") +
  labs(title="Lejáratok aránya",
       x="Arány (%)",
       y="Időszak")
```

## Kétváltozós kapcsoslatvizsgálat II.
### Időszak és lejárt kapcsolata

```{r warning=FALSE}
cramer.v(table(issues[issues$`Accepted (mln)`>0,c("Period", "Tenor")]))
```

A Cramer-együttható értéke 0.2882, a kapcsolat gyenge.

## Kétváltozós kapcsoslatvizsgálat II.
### Általánosítás a sokaságra

További kérdés, hogy a "sokaságban", vagyis a későbbi aukciók során is megmarad ez a gyenge kapcsolat, 

H0: C = 0 || H1: C > 0

``` {r warning=FALSE, echo=FALSE}
chisq.test(table(issues[issues$`Accepted (mln)`>0,
                        c("Period", "Tenor")]))
```
A p-érték lényegében 0-nak tekinthető, ezért semmilyen alfa érték mellett nem tudjuk elvetni H1-et, vagyis a kapcsolat gyenge, de szignifikáns.


## Kétváltozós kapcsoslatvizsgálat II.
### Feltételek

``` {r warning=FALSE, echo=TRUE}
table(issues[issues$`Accepted (mln)`>0,c("Period", "Tenor")])
```

A 6 hónapos referencia lejárat kivezetésre került, a 20 éves pedig bevezetésre.


## Két mennyiségi változó kapcsolata I.
### Mennyiség vs hozam

```{r echo=FALSE}
ggplot(data=bond5, aes(x=AcceptedAmount, y=Yield)) +
  geom_point() +
  labs("Hozam és elfogadott mennyiség kapcsolata\n5 éves kötvények aukcióján",
       x="Elfogadott mennyiség",
       y="Hozam")
```

## Két mennyiségi változó kapcsolata II.

Mennyiség vs hozam

```{r echo=FALSE}
sprintf("A két változó közötti korreláció: %s",
        cor(bond5successful$AcceptedAmount, bond5successful$Yield))
# (reg <- lm(Yield ~ AcceptedAmount, bond5successful))
```

A korreláció (-0.18) negatív és abszolút értéke kisebb 0.3-nál. A kapcsolat ellentétes, de gyenge.

A p-érték 0.0001 1%-nál is kisebb, ezért elvetjük, hogy az egyenes meredeksége 0, így a kapcsolat szignifikáns.


## Két mennyiségi változó kapcsolata III.{data-background=#bbffbb}

Mennyiség és árfolyam

```{r echo=FALSE}
ggplot(data=bond5successful, aes(x=AcceptedAmount, y=Price)) +
  geom_point() +
  labs("Hozam és elfogadott mennyiség kapcsolata\n5 éves kötvények aukcióján",
       x="Elfogadott mennyiség",
       y="Árfolyam") +
  geom_smooth(method=lm)
```

## Két mennyiségi változó kapcsolata IV.{data-background=#bbffbb}
```{r echo=FALSE}
sprintf("Mennyiség és árfolyam közötti korreláció: %s",
        cor(bond5successful$AcceptedAmount, bond5successful$Price))
(reg <- lm(Price ~ AcceptedAmount, bond5successful))
```


